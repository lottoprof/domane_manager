# Domain Manager

## Обзор
Domain Manager — это FastAPI-сервис для управления доменами, брендами, CDN-аккаунтами и другими сущностями, объединёнными под REST API с префиксом `/api`.

Приложение сопровождается статическим интерфейсом, который использует это API и хранит токены доступа в локальном хранилище браузера.

## Архитектура

### Backend
- Приложение FastAPI конфигурирует заголовки CORS и базовые обработчики ошибок, разрешая обращения с домена q-use.ru и локальных окружений.
- Все CRUD-роутеры агрегированы через модуль `app/api/routers.py`, что обеспечивает единообразный префикс `/api` и тегирование ресурсов (бренды, CDN-аккаунты, домены, пользователи и т.д.).
- Эндпоинты реализованы по типовой схеме: получение списка/объекта, создание, обновление и удаление с проверкой прав и обработкой 404.
- Подключение к PostgreSQL выполняется через синхронные и асинхронные движки SQLAlchemy; базовая модель и фабрики сессий описаны в `app/core/db.py`.
- SQLAlchemy-модели отражают структуру доменных сущностей (пример — таблица `domains`).
- Pydantic-схемы (пример `DomainsSchema`) включают поддержку работы с ORM и разделение на базовую, create- и read-модель.
- Аутентификация построена на JWT: маршруты `/api/auth/register`, `/api/auth/login` и `/api/auth/me` выполняют регистрацию, вход и проверку токена, используя шифрование bcrypt и библиотеку `python-jose`.
- Ролевой контроль реализован функцией `check_access`, сверяющей действия пользователя с матрицей разрешений по ресурсам.

### Frontend
- Страница входа `domains/index.html` содержит форму авторизации и подключает клиентский скрипт аутентификации.
- Класс `Auth` управляет логином, хранением токена, проверкой статуса и редиректами между страницами интерфейса.
- Дашборд отображает сводные карточки и график на Chart.js, скрывая контент до подтверждения авторизации.
- Общий заголовок и навигация формируются динамически через `header.js` и шаблон `header.html`, включая бургер-меню и выбор языка.
- Дополнительная проверка прав на уровне интерфейса выполняется модулем `access.js`, который фильтрует пункты меню по роли пользователя.
- Страница доменов рендерит таблицу с тестовыми данными, раскрываемыми строками и кнопками действий, дополняемыми модальным подтверждением.

### Данные и инструменты
- SQL-скрипт `dm.sql` описывает полную схему базы данных с перечислением таблиц, связей и комментариев.
- `readme_dmsql.md` дополняет схему диаграммой сущностей и текстовыми расшифровками полей.
- Скрипт `generate_endpoints_and_router.py` генерирует Pydantic-схемы, CRUD-эндпоинты и файл роутеров на основании зарегистрированных моделей SQLAlchemy.
- Зависимости Python перечислены в `project/requirements.txt` (FastAPI, Uvicorn, SQLAlchemy, psycopg2, asyncpg, passlib, python-jose и пр.).
- Конфигурация Nginx `q-use.ru` показывает пример проксирования API на порт 8000 и отдачи статических файлов из каталога `domains`.
- `zone.json` хранит пример выгрузки зон Cloudflare, который может использоваться для интеграции с CDN-аккаунтами.

## Установка и запуск
1. Установите зависимости проекта:
   ```bash
   pip install -r project/requirements.txt
   ```
2. Настройте подключение к PostgreSQL, отредактировав `DB_NAME`, `DB_USER` и `DB_HOST` в `app/core/db.py` или вынеся их в переменные окружения/конфиг.
3. Примените SQL-скрипт `dm.sql` к целевой базе данных, чтобы создать все таблицы и типы (при необходимости).
4. Запустите приложение, например:
   ```bash
   uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
   ```
   Основной модуль уже содержит пример вызова Uvicorn для разработки.

## API и авторизация
- Зарегистрируйте пользователя запросом `POST /api/auth/register`, выполните вход через `POST /api/auth/login` и используйте токен из ответа в заголовке `Authorization: Bearer <token>` для последующих запросов.
- Маршрут `GET /api/auth/me` возвращает данные текущего пользователя и используется фронтендом для хранения роли в LocalStorage.
- Каждый CRUD-эндпоинт проверяет права через `check_access`, поэтому роли `admin`, `editor` и `user` имеют различный набор действий (пример — `GET /api/domains`).

## Развёртывание и статические файлы
- Каталог `domains/` содержит статический интерфейс; в продакшне его можно обслуживать через Nginx, пробрасывая `/api/` на запущенный FastAPI-сервер и разрешая CORS.
- Дополнительные данные для настройки CDN/Cloudflare можно брать из `zone.json`, а ER-диаграмма в `readme_dmsql.md` помогает проверять целостность модели данных при развёртывании.
